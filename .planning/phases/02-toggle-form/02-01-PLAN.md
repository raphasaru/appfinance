---
phase: 02-toggle-form
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hooks/use-transactions.ts
autonomous: true

must_haves:
  truths:
    - "UI atualiza imediatamente ao clicar toggle (< 100ms)"
    - "Erro do servidor reverte estado visual"
    - "Toast de sucesso aparece apos confirmacao do servidor"
  artifacts:
    - path: "src/lib/hooks/use-transactions.ts"
      provides: "Optimistic mutations for complete/uncomplete"
      contains: "onMutate"
  key_links:
    - from: "useCompleteTransaction onMutate"
      to: "queryClient.setQueryData"
      via: "immediate cache update"
      pattern: "setQueryData.*transactions"
---

<objective>
Add optimistic updates to useCompleteTransaction and useUncompleteTransaction hooks.

Purpose: UI responds instantly to toggle taps, improving perceived performance.
Output: Hooks with onMutate/onError/onSettled callbacks for immediate cache updates.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/hooks/use-transactions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic update to useCompleteTransaction</name>
  <files>src/lib/hooks/use-transactions.ts</files>
  <action>
Modify useCompleteTransaction mutation to add TanStack Query optimistic update pattern:

1. Add onMutate callback:
   - Cancel outgoing queries: `queryClient.cancelQueries({ queryKey: ["transactions"] })`
   - Get all matching transaction queries (any month may contain this transaction)
   - For each query, update the transaction in cache: status -> "completed", completed_date -> today
   - Return { previousQueries } for rollback

2. Add onError callback:
   - Restore all previousQueries using `queryClient.setQueryData`
   - Show toast.error("Erro ao marcar como pago")

3. Modify onSuccess:
   - Remove toast (move to component) OR keep for confirmation
   - Keep invalidateQueries for server sync

4. Add onSettled callback:
   - Invalidate transactions and summary queries

Implementation pattern:
```typescript
onMutate: async (id: string) => {
  await queryClient.cancelQueries({ queryKey: ["transactions"] });

  // Get all cached transaction queries
  const queryCache = queryClient.getQueryCache();
  const queries = queryCache.findAll({ queryKey: ["transactions"] });

  const previousQueries: Array<{ queryKey: unknown[]; data: unknown }> = [];

  queries.forEach((query) => {
    const data = query.state.data as Transaction[] | undefined;
    if (!data) return;

    previousQueries.push({ queryKey: query.queryKey, data });

    queryClient.setQueryData(query.queryKey,
      data.map((t) =>
        t.id === id
          ? { ...t, status: "completed", completed_date: format(new Date(), "yyyy-MM-dd") }
          : t
      )
    );
  });

  return { previousQueries };
},
onError: (err, id, context) => {
  context?.previousQueries.forEach(({ queryKey, data }) => {
    queryClient.setQueryData(queryKey, data);
  });
},
onSettled: () => {
  queryClient.invalidateQueries({ queryKey: ["transactions"] });
  queryClient.invalidateQueries({ queryKey: ["summary"] });
},
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>useCompleteTransaction has onMutate that updates cache immediately</done>
</task>

<task type="auto">
  <name>Task 2: Add optimistic update to useUncompleteTransaction</name>
  <files>src/lib/hooks/use-transactions.ts</files>
  <action>
Same pattern as Task 1, but for useUncompleteTransaction:

1. onMutate: Set status -> "planned", completed_date -> null
2. onError: Restore previous state
3. onSettled: Invalidate queries

The only difference from useCompleteTransaction:
- status: "planned" instead of "completed"
- completed_date: null instead of today's date
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>useUncompleteTransaction has onMutate that updates cache immediately</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Both hooks export correctly
</verification>

<success_criteria>
- Clicking toggle updates UI immediately (before server response)
- Simulated server error reverts the toggle state
- Cache invalidation still happens for server sync
</success_criteria>

<output>
After completion, create `.planning/phases/02-toggle-form/02-01-SUMMARY.md`
</output>
